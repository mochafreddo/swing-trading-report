# 코드베이스 종합 리뷰 (2026-02-06)

## Summary (전체 평가)

- 모듈 경계(`config/data/signals/report`)는 비교적 명확하고, 시간대/평가 인덱스(`eval_index`) 관련 테스트가 탄탄합니다.
- 다만 실전 운용 기준에서는 손절 로직, 입력 파싱 실패 처리, 파일 저장 원자성 측면에서 치명적인 리스크가 있습니다.
- 결론: 현재는 "잘 만든 개인 프로젝트" 수준이며, "프로덕션-grade"로 보려면 핵심 안정성 보강이 필요합니다.

검증 메모:

- `PYTHONPATH=. uv run pytest -q` 기준: `68 passed`
- `uv run pytest -q` 기준: `ModuleNotFoundError: No module named 'sab'`로 수집 단계 실패

---

## Critical Issues

### 1) [CRITICAL] ATR 트레일링 스탑이 사실상 발동하지 않음

- 위치: `sab/signals/sell_rules.py:105`, `sab/signals/sell_rules.py:107`
- 현재 로직:
  - `stop_price = close_today - k*ATR`
  - 직후 `close_today <= stop_price` 검사
- 문제: 같은 `close_today`로 계산/비교하므로 조건이 구조적으로 거의 항상 `False`입니다.
- 영향: 하락 보호(손절)가 실제로 작동하지 않아 손실 관리 실패 가능성이 큽니다.
- 권장 수정:
  - 기준을 "현재 close"가 아닌 "이전 봉 기반 stop" 또는 "진입 이후 최고가/최고종가 기반 trailing stop"으로 변경
  - 예: `trail = highest_close_since_entry - k*ATR`; `close_today <= trail`일 때 SELL

### 2) [CRITICAL] holdings/config 파싱 실패 시 조용히 빈 데이터로 진행(fail-open)

- 위치: `sab/holdings_loader.py:63`, `sab/config_loader.py:32`
- 문제: 파싱 실패 시 예외를 올리지 않고 빈 설정/빈 보유목록을 반환합니다.
- 영향: 실제 파일 손상/오타가 있어도 "보유 종목 없음"처럼 처리되어 평가 누락 위험이 발생합니다.
- 권장 수정:
  - 기본값을 fail-closed로 변경(명시적 에러 + non-zero exit)
  - 필요 시 옵트인 플래그(예: `--allow-partial`)로만 완화

---

## Major Improvement Suggestions

### 1) `run_sell`에서 `suffix` 스코프 버그

- 위치: `sab/sell.py:301`
- 문제: 홀딩 루프 내부에서 해당 티커 suffix를 다시 계산하지 않고 외부 루프 변수 `suffix`를 참조합니다.
- 영향: `exchange` 메타데이터가 잘못 들어갈 수 있습니다.
- 권장: 홀딩 루프 내부에서 `base_symbol, suffix = _split_symbol_and_suffix(ticker)`를 다시 계산

### 2) 캐시/리포트 저장 원자성 부족 (경쟁 상태 가능)

- 위치:
  - `sab/data/cache.py:20`
  - `sab/report/markdown.py:15`
  - `sab/report/sell_report.py:95`
- 문제: `exists -> write`와 직접 overwrite 패턴으로 동시 실행 시 덮어쓰기/깨진 파일 가능성이 있습니다.
- 권장:
  - `temp file + os.replace` 원자적 쓰기
  - 리포트 파일명 생성 및 쓰기 구간에 파일락 도입

### 3) 시크릿 관리 정책 리스크

- 위치: `sab/config.py:456`, `.gitignore:1`
- 문제: `config.yaml`에서도 시크릿을 읽는데, `config.yaml`은 ignore 대상이 아닙니다.
- 영향: 키/시크릿 커밋 실수 가능성이 큽니다.
- 권장:
  - 시크릿은 `.env` 또는 키체인으로 강제
  - 최소한 `config.yaml` ignore 또는 `config.local.yaml` 패턴 도입

### 4) 미국 휴장일 판정 경로 불일치 가능성

- 위치: `sab/signals/eval_index.py:40`, `sab/scan.py:395`
- 문제: 스캔은 `cfg.data_dir`를 사용해 휴장일 캐시를 갱신하지만, 평가는 `SAB_DATA_DIR` 또는 기본 `data`를 사용합니다.
- 영향: 환경에 따라 판정 불일치가 생길 수 있습니다.
- 권장: 평가 모듈도 `cfg.data_dir`를 명시적으로 주입받도록 통일

### 5) ETF 제외 필터 과소탐지

- 위치: `sab/signals/etf_filters.py:26`
- 관측 근거: `reports/2026-02-06.buy.md:11` (ETF로 보이는 종목 다수 후보 포함)
- 문제: 키워드 사전이 좁아 `ISHARES`, `SPDR`, `VANGUARD` 등 대표 ETF 명칭이 누락됩니다.
- 권장: ETF 명칭 사전 확장 + 거래소/상품타입 메타 필드 기반 보강

### 6) 오케스트레이션 함수 비대

- 위치: `sab/scan.py:99`, `sab/sell.py:63`
- 문제: 데이터 수집/폴백/평가/리포팅/에러 집계가 단일 함수에 응집되어 변경 리스크가 큽니다.
- 권장: `collect -> evaluate -> render` 유스케이스 서비스 계층으로 분리

---

## Minor / Nice-to-have Suggestions

### 1) 소수점 수량이 요약표에서 0으로 반올림됨

- 위치: `sab/report/sell_report.py:149`
- 영향: 미국 소수점 매수 포지션에서 오해 가능
- 권장: 수량 자릿수 configurable 표시(예: 4~6자리)

### 2) 리포트 시간 라벨 KST 고정

- 위치: `sab/report/markdown.py:54`, `sab/report/sell_report.py:116`
- 문제: 로컬 시간이 KST가 아닐 수 있는데 라벨은 항상 KST
- 권장: 타임존 기반 동적 라벨 또는 UTC 고정

### 3) `Config` 필드 중복 선언

- 위치: `sab/config.py:118`, `sab/config.py:120`
- 문제: `hybrid` 필드가 중복 선언되어 코드 신뢰도 저하
- 권장: 중복 제거

### 4) KR 내장 휴일 데이터 오타

- 위치: `sab/data/kr_calendar.py:16`
- 문제: 2024 섹션에 2025 날짜(`20250606`, `20250815`)가 들어가 있음
- 권장: 연도별 검증 스크립트/테스트 추가

### 5) 테스트 실행 UX 불일치

- 위치: `pyproject.toml:1`
- 문제: 기본 `uv run pytest -q`가 실패하고 `PYTHONPATH=. uv run pytest -q`만 성공
- 권장: 패키지 설치형 테스트 환경 또는 pytest 설정에서 import path 정리

---

## Suggested Next Steps (우선순위)

1. **즉시(핫픽스)**: ATR 손절 로직, holdings/config fail-closed, `suffix` 스코프 버그 수정
2. **단기(안정화)**: 원자적 저장 + 파일락, ETF 필터 강화, 관련 회귀 테스트 추가
3. **중기(구조개선)**: `scan/sell` 유스케이스 분리, 에러 타입 표준화, 시크릿/설정 정책 문서화

